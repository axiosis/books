\addtocontents{toc}{\protect\newpage}
\chapter{–Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –±–µ–∑–ø–µ–∫–∏ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É}

\section{–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –ø—ñ–¥–ø–∏—Å —ñ —Ü–∏—Ñ—Ä–æ–≤–∞ –ø–µ—á–∞—Ç–∫–∞}

–ö–≤–∞–ª—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –ü—ñ–¥–ø–∏—Å, –∞–±–æ –ö–≤–∞–ª—ñ—Ñ—ñ–∫–ª–æ–≤–∞–Ω–∞ –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ü–µ—á–∞—Ç–∫–∞ ---
—Ü–µ –Ω–∞–±—ñ—Ä —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ–≥–æ –∑–∞—Ö–∏—Å—Ç—É –î–°–¢–£ 4145,
—Ç–∞ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ —è–∫—ñ –≤–∏–∑–Ω–∞—á–∞—é—Ç—å –π–æ–≥–æ –∫–æ–Ω–≤–µ—Ä—Ç: X.501, X.509, X.511, X.520.

\renewcommand{\footnotesize}{\scriptsize}

–°–µ—Ä—ñ—è –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ X.500, –≥—Ä—É–ø—É—î—Ç—å—Å—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º, –∫–æ–∂–Ω–∞
–∑ —è–∫–∏—Ö –º–∞—î —Å–≤—ñ–π –ø–µ—Ä–µ–ª—ñ–∫ ASN.1 —Ñ–∞–π–ª—ñ–≤. –ê–±–∏ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ —É—Å—ñ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ
–¥–ª—è –ö–ï–ü –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –Ω–∞—Å—Ç—É–ø—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ (–≤–∏–¥—ñ–ª–µ–Ω—ñ –±–æ–ª–¥–æ–º):
X.501 --- BasicAccessControl \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x501/2019/BasicAccessControl.html}},
InformationFramework \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x501/2019/InformationFramework.html}},
UsefulDefinitions \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x501/2019/UsefulDefinitions.html}};
X.509 --- SpkmGssTokens \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x509/2019/ExtensionAttributes.html}},
PkiPmiExternalDataTypes \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x509/2019/PkiPmiExternalDataTypes.html}},
AttributeCertificateDefinitions \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x509/2019/AttributeCertificateDefinitions.html}}, \\
AlgorithmObjectIdentifiers \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x509/2019/AlgorithmObjectIdentifiers.html}}, \\
AuthenticationFramework \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x509/2019/AuthenticationFramework.html}},
CertificateExtensions \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x509/2019/CertificateExtensions.html}}; \\
X.511 --- SpkmGssTokens \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x511/2019/SpkmGssTokens.html}},
DirectoryAbstractService \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x511/2019/DirectoryAbstractService.html}};
X.520 --- PasswordPolicy \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x520/2019/PasswordPolicy.html}},
UpperBounds \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x520/2019/UpperBounds.html}},
SelectedAttributeTypes \footnote{\url{https://www.itu.int/ITU-T/formal-language/itu-t/x/x520/2019/SelectedAttributeTypes.html}}.

–ú–æ–∂–Ω–æ –±—É–ª–æ –±–∏ –≤–∏–Ω–µ—Å—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –æ–¥—Ä–∞–∑—É –≤ KEP.asn1,
–æ–¥–Ω–∞–∫ —Ü–∏–º —Ö–æ—Ç—ñ–ª–æ—Å—è –ø—ñ–¥–∫—Ä–µ—Å–ª–∏—Ç–∏ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏. –û–∫—Ä—ñ–º —Å–µ—Ä—ñ—ó
–ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤ X.500, –ö–ï–ü —â–µ –≤–∏–∑–Ω–∞—á–∞—î —Ç–∞–∫–æ–∂ –∑–∞–ø–∏—Ç–∏ —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ OCSP, —Ç–∞–∫–æ–∂ —É ASN.1 —Ñ–æ—Ä–º–∞—Ç—ñ.

\newpage
–ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —Å–∞–º–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É –ö–ï–ü, —è–∫–∏–π –≤–∏–∑–Ω–∞—á–µ–Ω–æ –î–°–¢–£ 4145,
–∫–æ–Ω–≤–µ—Ä—Ç–∏ –≤–∏–∑–Ω–∞—á–∞—é—Ç—å—Å—è –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏, –∞ –Ω–∞–∫–∞–∑–∞–º–∏ –º—ñ–Ω—ñ—Å—Ç–µ—Ä—Å—Ç–≤–∞ —é—Å—Ç–∏—Ü—ñ—ó:
–ü—Ä–æ–µ–∫—Ç –Ω–∞–∫–∞–∑—É –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó –î–µ—Ä–∂—Å–ø–µ—Ü–∑–≤'—è–∑–∫—É —Ç–∞ –î–µ—Ä–∂–∫–æ–º—ñ–Ω—Ñ–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó (2009) \footnote{\url{http://www.dsszzi.gov.ua/dsszzi/control/uk/publish/article?art\_id=77726}},
–ù–∞–∫–∞–∑ –ú—ñ–Ω—ñ—Å—Ç–µ—Ä—Å—Ç–≤–∞ —é—Å—Ç–∏—Ü—ñ—ó –£–∫—Ä–∞—ó–Ω–∏ 1236/5/453 \footnote{\url{https://zakon.rada.gov.ua/laws/show/z1401-12}}.
–ö–µ—Ä—É—é—á–∏—Å—å —Ü–∏–º–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –±—É–ª–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª KEP.asn1 \footnote{\url{https://github.com/synrc/ca/blob/master/priv/kep/KEP.asn1}},
—è–∫–∏–π —î –æ–¥–Ω–∏–º –∑ —Ç—Ä—å–æ—Ö top-level —Ñ–∞–π–ª—ñ–≤ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—ó –¥–ª—è –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó ASN.1 –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä–æ–º\footnote{\url{https://asn1.erp.uno}}.

–Ü—Å–Ω—É—î –Ω–µ–±–∞–≥–∞—Ç–æ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö —Ç–∞ –ø–æ–≤–Ω–∏—Ö –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä—ñ–≤ (–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ñ–≤ –ø–∞—Ä—Å–µ—Ä—ñ–≤)
ASN.1 —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ–π. Erlang —î –ø—Ä–∏–∫–ª–∞–¥–æ–º —Å–∏—Å—Ç–µ–º–∏, –¥–æ —Å–∫–ª–∞–¥—É —è–∫–æ—ó –≤—Ö–æ–¥–∏—Ç—å
–ø–µ—Ä—à–æ–∫–ª–∞—Å–Ω–∏–π –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –∑ –≤—ñ–¥–∫—Ä–∏—Ç–æ—é –ª—ñ—Ü–µ–Ω—Ü—ñ—î—é ASN.1 –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä, –¥–µ
—Ñ–∞–π–ª–∏ –≤ ASN.1 –Ω–æ—Ç–∞—Ü—ñ—ó –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω—ñ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ Erlang –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä–æ–º:

\renewcommand{\footnotesize}{\normal}

\begin{lstlisting}
> erlc AuthenticationFramework.asn1
> erlc InformationFramework.asn1
> erlc KEP.asn1
\end{lstlisting}

–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª –ø—ñ–¥–ø–∏—Å—É PKCS-7 –º–æ–∂–Ω–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –±—É–¥—å —è–∫–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ—ó –≤ –£–∫—Ä–∞—ó–Ω—ñ.
–ù–∞–π–ø—Ä–æ—Å—Ç—ñ—à–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–≤–æ—é –ö–ï–ü –ø–µ—á–∞—Ç–∫—É –±—É–¥—É—á–∏ –∫–ª—ñ—î–Ω—Ç–æ–º –ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫—É. –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é
"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¶–°–ö" –∫–æ–º–ø–∞–Ω—ñ—ó –Ü–Ü–¢ –≤–∏ –º–æ–∂–µ—Ç–µ –ø—ñ–¥–ø–∏—Å—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—É
—Ñ–æ—Ä–º—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ —É –≤–∏–≥–ª—è–¥—ñ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É.

\newpage
\subsection{–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è}

–©–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è –ö–ï–ü, —Ç–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç–∏–≤–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É,
—è–∫–∏–π –≤—à–∏—Ç–∏–π –≤ PCKS-7 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∏–º –ø—ñ–¥–ø–∏—Å–æ–º, –ø–æ–∫–∞–∂–µ–º–æ 5 —Ñ—É–Ω–∫—Ü—ñ–π:

\renewcommand{\footnotesize}{\scriptsize}

\begin{lstlisting}[utf8]
> CA.CAdES.readSignature
[
  {:certinfo, ~c"TINUA-2955020254",
   "–°–û–•–ê–¶–¨–ö–ò–ô –ú–ê–ö–°–ò–ú –ï–†–û–¢–ï–ô–û–í–ò–ß",
   "–ú–ê–ö–°–ò–ú –ï–†–û–¢–ï–ô–û–í–ò–ß", "–°–û–•–ê–¶–¨–ö–ò–ô",
   "–°–û–•–ê–¶–¨–ö–ò–ô –ú–ê–ö–°–ò–ú –ï–†–û–¢–ï–ô–û–í–ò–ß",
   [
     subjectKeyIdentifier: "VNXfTvJQccGtPgNhUftIQZV+mUROTgroLotsbtYZsFE=",
     authorityKeyIdentifier: "XphNUm+C84/0vi5ABGgN/rOvysLkBHVNB9CuTISwfB0=",
     keyUsage: [<<6, 192>>],
     certificatePolicies: {"https://acsk.privatbank.ua/acskdoc",
      ["1.2.804.2.1.1.1.2.2", "1.3.6.1.5.5.7.2.1"]},
     basicConstraints: [],
     qcStatements: {"https://acsk.privatbank.ua",
      ["0.4.0.1862.1.1", "0.4.0.1862.1.5", "1.3.6.1.5.5.7.11.2",
       "0.4.0.194121.1.1", "1.2.804.2.1.1.1.2.1"]},
     cRLDistributionPoints: ["http://acsk.privatbank.ua/crl/PB-2023-S6.crl"],
     freshestCRL: ["http://acsk.privatbank.ua/crldelta/PB-Delta-2023-S6.crl"],
     authorityInfoAccess: [
       {"1.3.6.1.5.5.7.48.2",
        "http://acsk.privatbank.ua/arch/download/PB-2023.p7b"},
       {"1.3.6.1.5.5.7.48.1", "http://acsk.privatbank.ua/services/ocsp/"}
     ],
     subjectInfoAccess: [
       {"1.3.6.1.5.5.7.48.3", "http://acsk.privatbank.ua/services/tsp/"}
     ],
     subjectDirectoryAttributes: [
       {"1.2.804.2.1.1.1.11.1.4.7.1", "0"},
       {"1.2.804.2.1.1.1.11.1.4.1.1", "2955020254"}
     ]
   ], "–§–Ü–ó–ò–ß–ù–ê –û–°–û–ë–ê", "", "", ~c"UA", "–ö–ò–á–í"},
  {:certinfo, ~c"UA-14360570-2310",
   "–ö–ù–ï–î–ü –ê–¶–°–ö –ê–¢ –ö–ë \"–ü–†–ò–í–ê–¢–ë–ê–ù–ö\"", "", "",
   "–ö–ù–ï–î–ü –ê–¶–°–ö –ê–¢ –ö–ë \"–ü–†–ò–í–ê–¢–ë–ê–ù–ö\"",
   [
     contentType: "0.6.9.42.840.113549.1.7.1",
     signingTime: "240221110356Z",
     messageDigest: "MfvlhoDVCPkptQRN+S2zNGp0nrOsS93mLdbcz/kZ9GI=",
     signingCertificateV2: 540041581425012649131508804155871837613877419268,
     contentTimestamp: {"1.2.840.113549.1.7.2",
      36995253346304402407284752111874897026, "20240221110626Z",
      "MfvlhoDVCPkptQRN+S2zNGp0nrOsS93mLdbcz/kZ9GI="}
   ], "–ê–¢ –ö–ë \"–ü–†–ò–í–ê–¢–ë–ê–ù–ö\"", "", "", ~c"UA", "–ö–∏—ó–≤"}
]
\end{lstlisting}
\renewcommand{\footnotesize}{\normal}

\newpage
\section{–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω—ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è}

–†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø–æ–≤–∏–Ω–Ω—ñ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤, —É–∑–≥–æ–¥–∂–µ–Ω–Ω—è –∫–ª—é—á—ñ–≤
—ñ —Ä–∞–Ω—ñ—à–µ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω—ñ —Å–∏–º–µ—Ç—Ä–∏—á–Ω—ñ –∫–ª—é—á—ñ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ñ ktri,
kari —Ç–∞ kekri –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ.

–†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º–æ–∂—É—Ç—å –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–ª—é—á–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–∞—Ä–æ–ª—è,
–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–µ pwri. –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ú–û–ñ–£–¢–¨ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ —ñ–Ω—à—ñ –º–µ—Ç–æ–¥–∏
–∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–ª—é—á–∞–º–∏, —Ç–∞–∫—ñ —è–∫ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ë–æ–Ω–µ-–§—Ä–∞–Ω–∫–ª—ñ–Ω–∞
—Ç–∞ –ë–æ–Ω–µ-–ë–æ–π—î–Ω–∞ (RFC 5409) –∞–±–æ —ñ–Ω—à—ñ –º–µ—Ç–æ–¥–∏ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è SYNRC, —Ç–∞–∫—ñ —è–∫ –≤–∞—Ä—ñ–∞–Ω—Ç–∏
KYBER Key Transport (LAMPS-WG) –¥–ª—è –ø–æ—Å—Ç–∫–≤–∞–Ω—Ç–æ–≤–æ—ó –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—ó (PQC).

IETF (SMIME-WG) —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏: 5990, 5911, 5750--5754, 5652, 5408, 5409,
5275, 5126, 5035, 4853, 4490, 4262, 4134, 4056, 4010, 3850, 3851,
3852, 3854, 3855, 3657, 3560, 3565, 3537, 3394, 3369, 3370, 3274,
3114, 3278, 3218, 3211, 3217, 3183, 3185, 3125--3126, 3058, 2984,
2876, 2785, 2630, 2631, 2632 , 2633, 5083, 5084, 2634.

–°—É–º—ñ—Å–Ω—ñ—Å—Ç—å: Erlang SSL, LibreSSL CMS, OpenSSL CMS, GnuPG S/MIME.

\subsection{–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è}

–°–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å CMS X.509 –¥–ª—è
–¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏ RSA (Key Transport), ECC (Key Agreement), KEK (Key Encryption Key)
–¥–ª—è –¥–æ–¥–∞—Ç–∫—ñ–≤ Erlang/OTP, —è–∫—ñ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø—Ä–µ–∂–∏–≤–∞–ª–∞ heartbleed (!) CRYPTO —Ç–∞ SSL.
–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —è–∫ –º–æ–¥—É–ª—å CMS –ø—Ä–æ–≥—Ä–∞–º–∏ CA.

\renewcommand{\footnotesize}{\scriptsize}

\begin{lstlisting}
defmodule CMS do
    def decrypt(cms, {schemeOID, privateKeyBin}) do
        {_,{:ContentInfo,_,{:EnvelopedData,_,_,x,y,_}}} = cms
        {:EncryptedContentInfo,_,{_,encOID,{_,<<_::16,iv::binary>>}},data} = y
              case :proplists.get_value(:kari,  x, []) do
        [] -> case :proplists.get_value(:ktri,  x, []) do
        [] -> case :proplists.get_value(:kekri, x, []) do
        [] -> case :proplists.get_value(:pwri,  x, []) do
        [] -> {:error, "Unknown Other Recepient Info"}
              pwri  -> pwri(pwri,   privateKeyBin, encOID, data, iv) end
              kekri -> kekri(kekri, privateKeyBin, encOID, data, iv) end
              ktri  -> ktri(ktri,   privateKeyBin, encOID, data, iv) end
              kari  -> kari(kari,   privateKeyBin, schemeOID, encOID, data, iv) end
    end
end
\end{lstlisting}

\newpage
\subsection{CMS-KARI-ECC}

IETF 3278:2002 –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –µ–ª—ñ–ø—Ç–∏—á–Ω–∏—Ö
–∫—Ä–∏–≤–∏—Ö (ECC) —É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—ñ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (CMS) —ñ–∑
–ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é Suite B IETF 5008:2007, 6318:2011.

\begin{lstlisting}
$ openssl cms -decrypt -in encrypted.txt -inkey client.key -recip client.pem
$ openssl cms -encrypt -aes256 -in message.txt -out encrypted.txt \
                       -recip client.pem -keyopt ecdh_kdf_md:sha256
\end{lstlisting}

CMS Codec KARI: ECC+KDF/ECB+AES/KW+256/CBC:

\begin{lstlisting}
def map(:'dhSinglePass-stdDH-sha512kdf-scheme'), do: :sha512
def map(:'dhSinglePass-stdDH-sha384kdf-scheme'), do: :sha384
def map(:'dhSinglePass-stdDH-sha256kdf-scheme'), do: :sha256
def eccCMS(ukm, bit), do:
    :'CMSECCAlgs-2009-02'.encode(:'ECC-CMS-SharedInfo', sharedInfo(ukm, bit))
def sharedInfo(ukm, len), do: {:'ECC-CMS-SharedInfo',
    {:'KeyWrapAlgorithm',{2,16,840,1,101,3,4,1,45},:asn1_NOVALUE}, ukm, <>}

def kari(kari, privateKeyBin, schemeOID, encOID, data, iv) do
    {_,:v3,{_,{_,_,publicKey}},ukm,{_,kdfOID,_},[{_,_,encryptedKey}]} = kari
    {scheme,_}  = CA.ALG.lookup(schemeOID)
    {kdf,_}     = CA.ALG.lookup(kdfOID)
    {enc,_}     = CA.ALG.lookup(encOID)
    sharedKey   = :crypto.compute_key(:ecdh,publicKey,privateKeyBin,scheme)
    {_,payload} = eccCMS(ukm, 256)
    derived     = KDF.derive(map(kdf), sharedKey, 32, payload)
    unwrap      = CA.AES.KW.unwrap(encryptedKey, derived)
    res         = CA.AES.decrypt(enc, data, unwrap, iv)
    {:ok, res}
end
def testDecryptECC(), do: CA.CMS.decrypt(testECC(), testPrivateKeyECC())

def testECC() do
    {:ok,base} = :file.read_file "priv/certs/encrypted.txt"
    [_,s] = :string.split base, "\n\n"
    x = :base64.decode s
    :'CryptographicMessageSyntax-2010'.decode(:ContentInfo, x)
end

def testPrivateKeyECC() do
    privateKey = :public_key.pem_entry_decode(pem("priv/certs/client.key"))
    {:'ECPrivateKey',_,privateKeyBin,{:namedCurve,schemeOID},_,_} = privateKey
    {schemeOID,privateKeyBin}
end
\end{lstlisting}


\newpage
\subsection{CMS-KEKRI-KEK}

–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–¥–µ—Ä–∂—É–≤–∞—á–∞ –∫–ª—é—á–∞ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∫–ª—é—á–∞, —è–∫ –≤–∏–∑–Ω–∞—á–µ–Ω–æ CMS IETF 5652:2009, 3852:2004, 3369:2002, 2630:1999.

\begin{lstlisting}
$ openssl cms -encrypt -secretkeyid 07 \
              -secretkey 0123456789ABCDEF0123456789ABCDEF \
              -aes256 -in message.txt -out encrypted2.txt

$ openssl cms -decrypt -in encrypted2.txt -secretkeyid 07 \
              -secretkey 0123456789ABCDEF0123456789ABCDEF
\end{lstlisting}

CMS Codec KEKRI: KEK+AES-KW+CBC:

\begin{lstlisting}
def kekri(kekri, privateKeyBin, encOID, data, iv) do
    {:'KEKRecipientInfo',_vsn,_,{_,kea,_},encryptedKey} = kekri
    _ = CA.ALG.lookup(kea)
    {enc,_} = CA.ALG.lookup(encOID)
    unwrap = CA.AES.KW.unwrap(encryptedKey,privateKeyBin)
    res = CA.AES.decrypt(enc, data, unwrap, iv)
    {:ok, res}
end
def testDecryptKEK(), do: CA.CMS.decrypt(testKEK(), testPrivateKeyKEK())

def testPrivateKeyKEK() do
    {:kek, :binary.decode_hex("0123456789ABCDEF0123456789ABCDEF")}
end

def testKEK() do
    {:ok,base} = :file.read_file "priv/certs/encrypted2.txt"
    [_,s] = :string.split base, "\n\n"
    x = :base64.decode s
    :'CryptographicMessageSyntax-2010'.decode(:ContentInfo, x)
end
\end{lstlisting}

\newpage
\subsection{CMS-KTRI-RSA}

The very first CMS IETF 3852:1999:

\begin{lstlisting}
$ gpgsm --list-keys
$ gpgsm --list-secret-keys
$ gpgsm -r 0xD3C8F78A -e CNAME > cms.bin
$ gpgsm -u 0xD3C8F78A -d cms.bin
$ gpgsm --export-secret-key-p12 0xD3C8F78A > key.bin

$ openssl pkcs12 -in key.bin -nokeys -out public.pem
$ openssl pkcs12 -in key.bin -nocerts -nodes -out private.pem
\end{lstlisting}

CMS Codec KTRI: RSA+RSAES-OAEP:

\begin{lstlisting}
def ktri(ktri, privateKeyBin, encOID, data, iv) do
    {:'KeyTransRecipientInfo',_vsn,_,{_,schemeOID,_},key} = ktri
    {:rsaEncryption,_} = CA.ALG.lookup schemeOID
    {enc,_} = CA.ALG.lookup(encOID)
    sessionKey = :public_key.decrypt_private(key, privateKeyBin)
    res = CA.AES.decrypt(enc, data, sessionKey, iv)
    {:ok, res}
end
def testDecryptRSA(), do: CA.CMS.decrypt(testRSA(), testPrivateKeyRSA())

def testPrivateKeyRSA() do
    {:ok,bin} = :file.read_file("priv/rsa-cms.key")
    pki = :public_key.pem_decode(bin)
    [{:PrivateKeyInfo,_,_}] = pki
    rsa = :public_key.pem_entry_decode(hd(pki))
    {:'RSAPrivateKey',:'two-prime',_n,_e,_d,_,_,_,_,_,_} = rsa
    {:rsaEncryption,rsa}
end

def testRSA() do
    {:ok,x} = :file.read_file "priv/rsa-cms.bin"
    :'CryptographicMessageSyntax-2010'.decode(:ContentInfo, x)
end
\end{lstlisting}

\subsection{KDF}

KDF (MD5: 128, SHA: 160‚Äî512) and HKDF (HMAC) Key Derive functions used in ECC CMS schemes as of NIST SP 800-108r1.

\begin{lstlisting}
defmodule KDF do
    def hl(:md5),    do: 16
    def hl(:sha),    do: 20
    def hl(:sha224), do: 28
    def hl(:sha256), do: 32
    def hl(:sha384), do: 48
    def hl(:sha512), do: 64

    def derive(h, d, len, x) do
        :binary.part(:lists.foldr(fn i, a ->
            :crypto.hash(h, d <> <> <> x) <> a
        end, <<>>, :lists.seq(1,round(Float.ceil(len/hl(h))))), 0, len)
    end
end
\end{lstlisting}

\newpage
\subsection{AES-KW}

AES Key Wrap function is applicable to keys of 128/192/256 bit using AES-ECB encoding as of RFC 5649:2009 Advanced Encryption Standard (AES) Key Wrap with Padding Algorithm.

\begin{lstlisting}
-define(MSB64,      1/unsigned-big-integer-unit:64).
-define(DEFAULT_IV, << 16#A6A6A6A6A6A6A6A6:?MSB64 >>).

unwrap(CipherText, KEK) -> unwrap(CipherText, KEK, ?DEFAULT_IV).
unwrap(CipherText, KEK, IV)
        when (byte_size(CipherText) rem 8) =:= 0
        andalso (bit_size(KEK) =:= 128
            orelse bit_size(KEK) =:= 192
            orelse bit_size(KEK) =:= 256) ->
    BlockCount = (byte_size(CipherText) div 8) - 1,
    IVSize = byte_size(IV),
    case do_unwrap(CipherText, 5, BlockCount, KEK) of
        << IV:IVSize/binary, PlainText/binary >> ->
            PlainText;
        _ ->
            erlang:error({badarg, [CipherText, KEK, IV]})
    end.

codec(128) -> aes_128_ecb;
codec(192) -> aes_192_ecb;
codec(256) -> aes_256_ecb.

do_unwrap(Buffer, J, _BlockCount, _KEK) when J < 0 -> Buffer;
do_unwrap(Buffer, J, BlockCount, KEK) ->
    do_unwrap(do_unwrap(Buffer, J, BlockCount, BlockCount, KEK),
              J - 1, BlockCount, KEK).
do_unwrap(Buffer, _J, I, _BlockCount, _KEK) when I < 1 -> Buffer;
do_unwrap(<< A0:?MSB64, Rest/binary >>, J, I, BlockCount, KEK) ->
    HeadSize = (I - 1) * 8,
    << Head:HeadSize/binary, B0:8/binary, Tail/binary >> = Rest,
    Round = (BlockCount * J) + I,
    A1 = A0 bxor Round,
    Data = << A1:?MSB64, B0/binary >>,
    << A2:8/binary, B1/binary >>
        = crypto:crypto_one_time(codec(bit_size(KEK)),
          KEK, ?DEFAULT_IV, Data, [{encrypt,false}]),
    do_unwrap(<< A2/binary, Head/binary, B1/binary,
          Tail/binary >>, J, I - 1, BlockCount, KEK).
\end{lstlisting}

\newpage
\subsection{AES-256}

All AES-256 flavours are implemented for a wide range of ECC Key Agreement schemes.

\begin{lstlisting}
def decrypt(crypto_codec, data, key, iv \\ :crypto.strong_rand_bytes(16))
def decrypt(:'id-aes256-ECB',data,key,iv), do: decryptAES256ECB(data,key,iv)
def decrypt(:'id-aes256-CBC',data,key,iv), do: decryptAES256CBC(data,key,iv)
def decrypt(:'id-aes256-GCM',data,key,iv), do: decryptAES256GCM(data,key,iv)
def decrypt(:'id-aes256-CCM',data,key,iv), do: decryptAES256CCM(data,key,iv)
def test() do
  [
    check_SECP384R1_GCM256(),
    check_X25519_GCM256(),
    check_C2PNB368w1_GCM256(),
    check_BrainPoolP512t1_GCM256(),
    check_BrainPoolP512t1_GCM256(),
    check_SECT571_GCM256(),
    check_X448_GCM256(),
    check_X448_CBC256(),
    check_X448_ECB256(),
  ]
end
\end{lstlisting}

\newpage
\section{–Ü–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è CMP —Å–µ—Ä–≤–µ—Ä–∞ —É —Å–∫–ª–∞–¥—ñ –ê–¶–°–ö}

IETF follow up (PKIX): 7030, 6960, 6818, 6844, 6712, 6664, 6402, 6277, 6170, 6024, 6025, 5934, 5912--5914, 5877, 5816, 5755, 5756, 5758, 5697, 5636, 5480, 5272--5274, 5280, 5055, 5019, 4985, 4683, 4630, 4476, 4387, 4325, 4158, 4210, 4211, 4055, 4043, 3874, 3779, 3820, 3739, 3709, 3628, 3161, 3029, 2797, 2559, 2587, 3039, 3029, 2511, 2510.

Compatibility: OpenSSL, Cisco, Red Hat, Siemens, Nokia, IBM.

–¶—è —Å—Ç–∞—Ç—Ç—è –º–æ–≥–ª–∞ –±–∏ –Ω–∞–∑–∏–≤–∞—Ç–∏ ¬´–Ø–∫ –Ω–∞–ø–∏—Å–∞—Ç–∏ CMP —Å–µ—Ä–≤–µ—Ä –∑–∞ 30 —Ö–≤–∏–ª–∏–Ω¬ª,
 –∞–ª–µ –Ω–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Å—Ç–∞—Ç—Ç—ñ –ø—Ä–æ LDAP, —Ü—è –≤–∂–µ –ø–æ–∫—Ä–∏–≤–∞—î –±—ñ–ª—å—à–µ –Ω—ñ–∂ —Ç—É–∑—ñ–Ω—å ASN.1 —Ñ–∞–π–ª—ñ–≤, –¥–æ–±—Ä–µ —à–æ –º–∏ –≤–∂–µ –ø–æ–∑–Ω–∞–π–æ–º–∏–ª–∏—Å—è –∑ CMS —Ç–∞ LDAP –±—ñ–±—ñ–ª—ñ–æ—Ç–µ–∫–∞–º–∏ —Ç–∞ —ó—Ö ASN.1 —Ñ–∞–π–ª–∞–º–∏. –í —Ü—ñ–π —Å—Ç–∞—Ç—Ç—ñ –ø—Ä–æ CMP –Ω–∞—Å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ü—ñ–∫–∞–≤–∏—Ç–∏–º—É—Ç—å PKIXCMP-2009, PKIXCRMF-2009 —Ç–∞ EnrollmentMessageSyntax-2009 –¥–ª—è CMC.

\renewcommand{\footnotesize}{\scriptsize}

\begin{lstlisting}
CMS-AES-CCM-and-AES-GCM-2009.asn1
CMSAesRsaesOaep-2009.asn1
CMSECCAlgs-2009-02.asn1
CMSECDHAlgs-2017.asn1
CryptographicMessageSyntax-2009.asn1
CryptographicMessageSyntax-2010.asn1
CryptographicMessageSyntaxAlgorithms-2009.asn1
EnrollmentMessageSyntax-2009.asn1
PKCS-10.asn1
PKCS-7.asn1
PKIX1Explicit-2009.asn1
PKIX1Implicit-2009.asn1
PKIXAlgs-2009.asn1
PKIXCMP-2009.asn1
PKIXCRMF-2009.asn1
\end{lstlisting}

\newpage
\subsection{CSR}

–û—Ç–∂–µ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–∞–ø–∏—Å–∞–Ω–Ω—è CMP —Å–µ—Ä–≤–µ—Ä—É –∑ –Ω–∞–π–≥–æ–ª–æ–≤–Ω—ñ—à–æ—ó –π–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ—ó: –≤–∏–¥–∞—á—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É –ø–æ PCKS-10 CSR —Ä–µ–∫–≤–µ—Å—Ç—É. –°—Ö–µ–º–∞ –Ω–∞—Å—Ç—É–ø–Ω–∞: –ö–ª—ñ—î–Ω—Ç –≥–µ–Ω–µ—Ä—É—î –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á, –∫–æ–Ω–≤–µ—Ä—Ç—É—î –π–æ–≥–æ –≤ PEM —Ñ–∞–π–ª, –≤—ñ–¥—Å–∏–ª–∞—î —è–∫ P10CR –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É —Å–∫–ª–∞–¥—ñ payload PKIMessage, –æ—Ç—Ä–∏–º—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å CP, –ø—ñ—Å–ª—è —á–æ–≥–æ –∫–ª—ñ—î–Ω—Ç —à–ª–µ —â–µ –æ–¥–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è CERTCONF, –ø—ñ—Å–ª—è —è–∫–æ–≥–æ CMP —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–∏–Ω–µ–Ω –≤—ñ–¥–ø–æ–≤–∏—Å—Ç–∏ PKICONF –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º.


\begin{lstlisting}
 def csr(user) do
      {ca_key, ca} = read_ca()
      priv = X509.PrivateKey.new_ec(:secp384r1)
      der = :public_key.der_encode(:ECPrivateKey, priv)
      pem = :public_key.pem_encode([{:ECPrivateKey, der, :not_encrypted}])
      :file.write_file(user <> ".key", pem)
      :io.format '~p~n', [priv]
      csr = X509.CSR.new(priv, "/C=UA/L=Kyiv/O=SYNRC/CN=" <> user,
         extension_request: [
            X509.Certificate.Extension.subject_alt_name(["n2o.dev"])])
      :io.format 'CSR: ~p~n', [csr]
      :file.write_file(user <> ".csr", X509.CSR.to_pem(csr))
      true = X509.CSR.valid?(csr)
      subject = X509.CSR.subject(csr)
      :io.format 'Subject ~p~n', [subject]
      :io.format 'CSR ~p~n', [csr]
      X509.Certificate.new(X509.CSR.public_key(csr), subject, ca, ca_key,
         extensions: [subject_alt_name:
           X509.Certificate.Extension.subject_alt_name(["n2o.dev", "erp.uno"]) ])
      csr
  end
\end{lstlisting}

\newpage
–ü–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º —Ä–æ–±–æ—Ç–∏ CMP —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π —Ä—É—Ç–æ–≤–∏–π CA —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∑ –ø—Ä–∏–≤–∞—Ç–Ω–∏–º –∫–ª—é—á–µ–º, —Ü—ñ –¥–≤–∞ —Ñ–∞–π–ª–∞ –º–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞ –¥–∏—Å–∫, —ñ —É –≤—Å—ñ—Ö –ø–æ–¥–∞–ª—å—à–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ—è—Ö –∫–æ—Ä–∏—Å—Ç—É—î–º–æ—Å—è –Ω–∏–º–∏. –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ñ–∞–π–ª—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é CA.CSR.ca.

\begin{lstlisting}
 def ca() do
      ca_key = X509.PrivateKey.new_ec(:secp384r1)
      ca = X509.Certificate.self_signed(ca_key,
            "/C=UA/L=Kyiv/O=SYNRC/CN=CSR-CMP", template: :root_ca)
      der = :public_key.der_encode(:ECPrivateKey, ca_key)
      pem = :public_key.pem_encode([{:ECPrivateKey, der, :not_encrypted}])
      :file.write_file "ca.key", pem
      :file.write_file "ca.pem", X509.Certificate.to_pem(ca)
      {ca_key, ca}
  end

  def read_ca() do
      {:ok, ca_key_bin} = :file.read_file "ca.key"
      {:ok, ca_bin} = :file.read_file "ca.pem"
      {:ok, ca_key} = X509.PrivateKey.from_pem ca_key_bin
      {:ok, ca} = X509.Certificate.from_pem ca_bin
      {ca_key, ca}
  end
\end{lstlisting}

–î–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—ó—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å–µ—Ä–≤–µ—Ä–Ω–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —è–∫—ñ –æ–±—Å—É–≥–æ–≤—É—é—Ç—å –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ TLS —Å–µ—Å—ñ—ó –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫–æ–¥.

\begin{lstlisting}
  def server(name) do
      {ca_key, ca} = read_ca()
      server_key = X509.PrivateKey.new_ec(:secp384r1)
        X509.Certificate.new(X509.PublicKey.derive(server_key),
           "/C=UA/L=Kyiv/O=SYNRC/CN=" <> name, ca, ca_key,
           extensions: [subject_alt_name:
              X509.Certificate.Extension.subject_alt_name(["n2o.dev", "erp.uno"]) ])
  end
\end{lstlisting}

\newpage
\subsection{CMS}

–î–µ—Ç–∞–ª—å–Ω–æ —Å—ñ–º–µ–π—Å—Ç–≤–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤ —ñ CMS –∫–æ–¥—É–≤–∞–Ω–Ω—è –æ–ø–∏—Å–∞–Ω–æ –≤ –æ–∫—Ä–µ–º—ñ–π —Å—Ç–∞—Ç—Ç—ñ –ø—Ä–∏—Å–≤—è—á–µ–Ω—ñ–π CMS Compliance. CMS –∫–æ–¥—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è CMC —Å–µ—Ä–≤–µ—Ä–∞, —Ç–æ–º—É –º–∏ —Ü–µ –ø–æ–∫–∏ –≤–∏—Å–≤—ñ—Ç–ª—é–≤–∞—Ç–∏ –Ω–µ –±—É–¥–µ–º–æ.

\subsubsection{CMP/CSR/TCP}

RFC 6712, 4210. –î–ª—è –ø–æ—á–∞—Ç–∫—É –Ω–∞–ø–∏—à–µ–º–æ –ø—Ä–æ—Å—Ç–∏–π PKIMessage —Å–µ—Ä–≤–µ—Ä.

\begin{lstlisting}
defmodule CA.CMP do
  @moduledoc "CA/CMP TCP server."
  require CA

  def start(), do: :erlang.spawn(fn -> listen(1829) end)
  def listen(port) do
      {:ok, socket} = :gen_tcp.listen(port,
        [:binary, {:packet, 0}, {:active, false}, {:reuseaddr, true}])
      accept(socket)
  end

  def accept(socket) do
      {:ok, fd} = :gen_tcp.accept(socket)
      :erlang.spawn(fn -> __MODULE__.loop(fd) end)
      accept(socket)
  end

  def loop(socket) do
      case :gen_tcp.recv(socket, 0) do
           {:ok, data} ->
               [headers,body] = :string.split data, "\r\n\r\n", :all
               {:ok,dec} = :'PKIXCMP-2009'.decode(:'PKIMessage', body)
               {:PKIMessage, header, body, code, _extra} = dec
               __MODULE__.message(socket, header, body, code)
               loop(socket)
          {:error, :closed} -> :exit
      end
  end
\end{lstlisting}

\newpage
\subsubsection{PKIMessage.protection}

–†–æ–∑–±–µ—Ä–µ–º–æ—Å—è –∑ –ø–æ–ª–µ–º PKIMessage.protection, –≤ —è–∫–æ–º—É –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç PBKDF2 –∞–ª–≥–æ—Ä–∏—Ç–º–∞. –ú–∞–π—Ç–µ –Ω–∞ —É–≤–∞–∑—ñ —à–æ OpenSSL –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î 20-–±–∞–π—Ç–Ω—ñ –∫–ª—é—á—ñ —Ç–∞ HMAC/SHA-1 —É —è–∫–æ—Å—Ç—ñ MAC —Ñ—É–Ω–∫—Ü—ñ—ó, —Ö–æ—á–∞ OWF –≤ 500 —ñ—Ç–µ—Ä–∞—Ü—ñ—è—Ö –æ–±—á–∏—Å–ª—é—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é OWF —Ñ—É–Ω–∫—Ü—ñ—ó SHA-256.

\subsubsection{ANSWER}

–û—Å–∫—ñ–ª—å–∫–∏ CMP —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–∏–Ω–µ–Ω –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø–æ HTTP/1.0 –∑–≥—ñ–¥–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ –¥–æ–¥–∞—î–º–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏.

\begin{lstlisting}
 def answer(socket, header, body, code) do
      message = CA."PKIMessage"(header: header, body: body, protection: code)
      {:ok, bytes} = :'PKIXCMP-2009'.encode(:'PKIMessage', message)
      res =  "HTTP/1.0 200 OK\r\n"
          <> "Server: SYNRC CA/CMP\r\n"
          <> "Content-Type: application/pkixcmp\r\n\r\n"
          <> :erlang.iolist_to_binary(bytes)
      :gen_tcp.send(socket, res)
  end
\end{lstlisting}

\subsubsection{P10CR/CP}

–ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä —Ç–∞ –≥–µ–Ω–µ—Ä—É—î–º–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ CA —Ç–∞ CSR –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:

\begin{lstlisting}
$ mix deps.get
$ iex -S mix
> CA.CSR.ca
> CA.CSR.csr "maxim"
\end{lstlisting}

–ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π –∑–∞–ø–∏—Ç –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é OpenSSL:

\begin{lstlisting}
# openssl cmp -cmd p10cr -server localhost:1829 \
#             -path . -srvcert ca.pem -ref cmptestp10cr \
#             -secret pass:0000 -certout $client.pem -csr $client.csr
\end{lstlisting}

\newpage
–ü–∏—à–µ–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –≤–∏–¥–∞—á—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É:

\begin{lstlisting}
def message(socket, header, {:p10cr, csr} = body, code) do
      {:PKIHeader, pvno, from, to, messageTime, protectionAlg,
         _senderKID, _recipKID, transactionID, senderNonce,
         _recipNonce, _freeText, _generalInfo} = header
      true = code == validateProtection(header, body, code)

      {ca_key, ca} = CA.CSR.read_ca()
      subject = X509.CSR.subject(csr)
      :io.format '~p~n',[subject]
      true = X509.CSR.valid?(CA.parseSubj(csr))
      cert = X509.Certificate.new(X509.CSR.public_key(csr),
         CA.CAdES.subj(subject), ca, ca_key,
         extensions: [subject_alt_name:
            X509.Certificate.Extension.subject_alt_name(["synrc.com"]) ])

      reply = CA."CertRepMessage"(response:
            [ CA."CertResponse"(certReqId: 0,
              certifiedKeyPair: CA."CertifiedKeyPair"(certOrEncCert:
                {:certificate, {:x509v3PKCert, CA.convertOTPtoPKIX(cert)}}),
              status: CA."PKIStatusInfo"(status: 0))])

      pkibody = {:cp, reply}
      pkiheader = CA."PKIHeader"(sender: to, recipient: from, pvno: pvno,
          recipNonce: senderNonce, transactionID: transactionID,
          protectionAlg: protectionAlg, messageTime: messageTime)
      answer(socket, pkiheader, pkibody,
          validateProtection(pkiheader, pkibody, code))
  end
\end{lstlisting}

\newpage
\subsubsection{CERTCONF/PKICONF}

\begin{lstlisting}
def message(socket, header, {:certConf, statuses}, code) do
      {:PKIHeader, _, from, to, _, _, _, _, _, senderNonce, _, _, _} = header

      :lists.map(fn {:CertStatus,bin,no,{:PKIStatusInfo, :accepted, _, _}} ->
          :logger.info 'CERTCONF ~p request ~p~n', [no,:binary.part(bin,0,8)]
      end, statuses)

      pkibody = {:pkiconf, :asn1_NOVALUE}
      pkiheader = CA."PKIHeader"(header, sender: to, recipient: from,
          recipNonce: senderNonce)
      answer(socket, pkiheader, pkibody,
          validateProtection(pkiheader, pkibody, code))
  end
\end{lstlisting}

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –≤ –∫–æ–Ω—Å–æ–ª—ñ –ø–æ–≤–∏–Ω–Ω—ñ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—Ç–∏:

\begin{lstlisting}
CMP info: sending P10CR
CMP info: received CP
CMP info: sending CERTCONF
CMP info: received PKICONF
CMP info: received 1 enrolled certificate(s), saving to file 'maxim.pem'
\end{lstlisting}

\subsubsection{GENM/GENP}

–î–∞–ª—ñ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:

\begin{lstlisting}
# openssl cmp -cmd genm -server 127.0.0.1:1829 \
#             -recipient "/CN=CMPserver" -ref 1234 -secret pass:0000
\end{lstlisting}

\begin{lstlisting}
def message(_socket, _header, {:genm, req} = _body, _code) do
      :io.format 'generalMessage: ~p~n', [req]
  end
\end{lstlisting}

\newpage
\subsubsection{IR/IP}

\begin{lstlisting}
# openssl cmp -cmd ir -server 127.0.0.1:1829 \
#             -path . -srvcert ca.pem -ref NewUser \
#             -secret pass:0000 -certout maxim.pem \
#             -newkey maxim.key -subject "/CN=maxim/O=SYNRC/ST=Kyiv/C=UA"
\end{lstlisting}

\begin{lstlisting}
 def message(_socket, _header, {:ir, req}, _) do
      :lists.map(fn {:CertReqMsg, req, sig, code} ->
         :io.format 'request: ~p~n', [req]
         :io.format 'signature: ~p~n', [sig]
         :io.format 'code: ~p~n', [code]
      end, req)
  end
\end{lstlisting}

\subsubsection{CR/CP}

\begin{lstlisting}
# openssl cmp -cmd cr -server 127.0.0.1:1829 \
#             -path . -srvcert ca.pem -ref NewUser \
#             -secret pass:0000 -certout maxim.pem \
#             -newkey maxim.key -subject "/CN=maxim/O=SYNRC/ST=Kyiv/C=UA"
\end{lstlisting}

\newpage
\subsubsection{–í–∏—Å–Ω–æ–≤–∫–∏}

\begin{lstlisting}
defmodule CA do
  use Application
  use Supervisor

  require Record
  Enum.each(Record.extract_all(from_lib: "ca/include/PKIXCMP-2009.hrl"),
            fn {name, definition} -> Record.defrecord(name, definition) end)

  Enum.each(Record.extract_all(from_lib: "public_key/include/public_key.hrl"),
            fn {name, definition} -> Record.defrecord(name, definition) end)

  def init([]), do: {:ok, { {:one_for_one, 5, 10}, []} }
  def start(_type, _args) do
      :logger.add_handlers(:ldap)
      CA.CMP.start
      CA.CMC.start
      :supervisor.start_link({:local, __MODULE__}, __MODULE__, [])
  end
\end{lstlisting}

–ù—É PasswordBasedMac –≤ –Ω–∞—Å —î, —Ç–µ–ø–µ—Ä —Ç—Ä–µ–±–∞ DHMac, –∞–ª–µ shared secret –º–æ–∂–Ω–∞ —ñ –≤ PBM –∑–∞—Å—É–Ω—É—Ç–∏. –Ñ —à–µ Proof Of Posession (POP) ‚Äî —Ç–∞–º –∑—Ä–∞–∑—É ECDSA verify. –Ø –¥–æ —Ä–µ—á—ñ –¥—É–º–∞—é –≤ CA —Ç—Ä–∏–º–∞—Ç–∏ –∫–ª—é—á—ñ –¥–ª—è –≤—Å—ñ—Ö –∫—Ä–∏–≤–∏—Ö, —ñ –∫–æ–ª–∏ —è –≤–∏—Å—Ç–∞–≤–ª—è—Ç–∏–º—É —Å–µ—Ä–≤—ñ—Å —Ç–æ —è –±—É–¥—É –≤–∏—Å—Ç–∞–≤–ª—è—Ç–∏ –π–æ–≥–æ –Ω–∞ N –ø–æ—Ä—Ç–∞—Ö —ñ N –∫–ª—é—á–∞—Ö, —â–æ–± –±—É–¥—å —è–∫–∏–π –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø—Ä–∏–π–º–∞–≤—Å—è —è–∫ —Ä—ñ–¥–Ω–∏–π! Chat üí¨ X.509 –¥–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∏–±–∏—Ä–∞—Ç–∏ TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ –æ–±—Ä–∞–Ω–∏—Ö –∫—Ä–∏–≤–∏—Ö. –í–∏ –≤–∏–±–∏—Ä–∞—î—Ç–µ –ø—ñ–¥ —è–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏ —Å—å–æ–≥–æ–¥–Ω—ñ –∑–∞—Ö–æ–¥–∏—Ç–∏. LDAP, MQTT, NS, CA ‚Äî –≤ –∫–æ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É —Å–≤–æ—ó N –ø–æ—Ä—Ç—ñ–≤ —ñ N —Å–µ—Ä–≤–µ—Ä–Ω–∏—Ö TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤. –ü–µ—Ä–µ–¥–±–∞—á–∞—î—Ç—å—Å—è —â–æ –ø–µ—Ä—à–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –≤–∏–¥–∞—î—Ç—å—Å—è DH –ø–æ TCP –∞ –ø–æ—Ç—ñ–º –∑—Ä–∞–∑—É –≤—Å—å–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ TLS —Ä–µ–∂–∏–º —ñ –≤—Å—ñ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –≤–∂–µ –≤–∏–¥–∞—é—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ–≥–æ TLS. –ü—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑—Ä–∞–∑—É –¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ LDAP —è–∫—à–æ –∑–∞—Ö–æ—Ç—ñ–≤ –∑—Ä–æ–±–∏—Ç–∏ —Å–µ–±–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –¥–ª—è –ø–æ—à—É–∫—É. –ü—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –ø–æ—à—É–∫ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó —ñ —Ñ—Ä–µ–Ω–¥—É–≤–∞–Ω–Ω—è (–æ–±–º—ñ–Ω –∫–ª—é—á–∞–º–∏) —ñ –ø–æ—ó—Ö–∞–ª–∏ —á–∞—Ç –≤ –æ–±–≥–æ—Ä—Ç–∫–∞—Ö CAdES, CMS, ECDSA/AES ‚Äî –ª–µ–π–±–∏ –±—ñ–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ü–Ü–î–ü–ò–°/–®–ò–§–†.

\section{–¶–µ–Ω—Ç—Ä–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó CA, –ê–¶–°–ö, –¶–ó–û —Ç–∞ –û–ó–û}

\section{–ë–µ–∑–ø–µ—á–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–º–µ–Ω–Ω–∏—Ö —ñ–º–µ–Ω DNSSEC}

\section{–°–∏—Å—Ç–µ–º–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞ LDAP}

\section{–ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–æ–∑–º–µ–∂—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É ABAC}

